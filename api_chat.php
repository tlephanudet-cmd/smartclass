<?php
/**
 * api_chat.php - Local AI Chatbot "Kru Tle AI"
 * Keyword Intelligence + LINE Messaging API Broadcast
 */
require_once 'includes/config.php';
require_once 'includes/functions.php';

header('Content-Type: application/json; charset=utf-8');

// ========== 1. AUTH CHECK ==========
if (!isset($_SESSION['user_id'])) {
    echo json_encode(['status' => 'error', 'reply' => 'р╕Бр╕гр╕╕р╕Ур╕▓р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ър╕Бр╣Ир╕нр╕Щр╕Др╕гр╕▒р╕Ъ']);
    exit();
}

$userId    = $_SESSION['user_id'];
$username  = $_SESSION['username'] ?? 'р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ';
$fullName  = $_SESSION['full_name'] ?? $username;

// ========== 2. GET INPUT ==========
$userMsg = trim($_POST['message'] ?? '');
if (empty($userMsg)) {
    echo json_encode(['status' => 'error', 'reply' => 'р╕Бр╕гр╕╕р╕Ур╕▓р╕Юр╕┤р╕бр╕Юр╣Мр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╕Бр╣Ир╕нр╕Щр╕Др╕гр╕▒р╕Ъ']);
    exit();
}

// ========== 3. LINE CONFIG ==========
$lineToken = 'uFTUUvcYesi3BshZ+TM+5gUzNesaDVGRPQ9V7DFwJF0AZsogt60yQu8QnpCm1QpIGjoeSRycmGn+iGcsyHFlWXswYAzbSrjBOrHVPom4s7SR7dWYP1TZXolIVaw2y0qtpVS3bZmX01rInglv+2h46AdB04t89/1O/w1cDnyilFU=';

// ========== 4. KNOWLEDGE BASE ==========
$knowledgeBase = [
    // === RISK (highest priority) ===
    'risk' => [
        'keywords' => ['р╕Жр╣Ир╕▓р╕Хр╕▒р╕зр╕Хр╕▓р╕в', 'р╣Др╕бр╣Ир╕нр╕вр╕▓р╕Бр╕нр╕вр╕╣р╣И', 'р╕нр╕вр╕▓р╕Бр╕Хр╕▓р╕в', 'р╕ер╕▓р╕Хр╕▓р╕в', 'р╣Вр╕Фр╕Щр╣Бр╕Бр╕ер╣Йр╕З', 'р╕Ър╕╣р╕ер╕ер╕╡р╣И', 'р╕гр╕▒р╕Зр╣Бр╕Б', 'р╕Чр╕│р╕гр╣Йр╕▓р╕вр╕Хр╕▒р╕зр╣Ар╕нр╕З', 'р╣Ар╕Ир╣Зр╕Ър╕Ыр╕зр╕Фр╕бр╕▓р╕Б', 'р╕Чр╕гр╕бр╕▓р╕Щ', 'р╕лр╕бр╕Фр╕лр╕зр╕▒р╕З'],
        'reply' => "р╕Др╕гр╕╣р╕гр╕▒р╕Ър╕гр╕╣р╣Йр╕Цр╕╢р╕Зр╕Др╕зр╕▓р╕бр╕гр╕╣р╣Йр╕кр╕╢р╕Бр╕Вр╕нр╕Зр╕лр╕Щр╕╣р╕Щр╕░ р╣Др╕бр╣Ир╕зр╣Ир╕▓р╣Ар╕Ир╕нр╕нр╕░р╣Др╕гр╕нр╕вр╕╣р╣И р╕Др╕гр╕╣р╕нр╕вр╕▓р╕Бр╣Гр╕лр╣Йр╕гр╕╣р╣Йр╕зр╣Ир╕▓р╕лр╕Щр╕╣р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕нр╕вр╕╣р╣Ир╕Др╕Щр╣Ар╕Фр╕╡р╕вр╕з\n\nЁЯУЮ р╕кр╕▓р╕вр╕Фр╣Ир╕зр╕Щр╕кр╕╕р╕Вр╕ар╕▓р╕Юр╕Ир╕┤р╕Х: 1323 (24 р╕Кр╕б.)\nЁЯПл р╕бр╕▓р╕Др╕╕р╕вр╕Бр╕▒р╕Ър╕Др╕гр╕╣р╣Ар╕Хр╕┤р╣Йр╕ер╕Чр╕╡р╣Ир╕лр╣Йр╕нр╕Зр╕Юр╕▒р╕Бр╕Др╕гр╕╣р╣Др╕Фр╣Йр╣Ар╕кр╕бр╕нр╕Щр╕░р╕Др╕гр╕▒р╕Ъ",
        'score' => 10,
        'priority' => 'EMERGENCY'
    ],

    // === BAD WORDS ===
    'bad_words' => [
        'keywords' => ['р╕лр╕вр╕▓р╕Ър╕Др╕▓р╕в', 'р╣Др╕нр╣Йр╕кр╕▒р╕Хр╕зр╣М', 'р╕Др╕зр╕в', 'р╣Ар╕лр╕╡р╣Йр╕в', 'р╕кр╕▒р╕к', 'р╕нр╕╡р╕Фр╕нр╕Б', 'р╕нр╕╡р╕кр╕▒р╕Хр╕зр╣М', 'р╣Ар╕вр╣Зр╕Ф', 'р╕бр╕╢р╕З', 'р╕Бр╕╣'],
        'reply' => "р╕Др╕гр╕╣р╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕зр╣Ир╕▓р╕нр╕▓р╕Ир╕бр╕╡р╕нр╕▓р╕гр╕бр╕Ур╣Мр╕лр╕Зр╕╕р╕Фр╕лр╕Зр╕┤р╕Ф р╣Бр╕Хр╣Ир╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Др╕│р╕Юр╕╣р╕Фр╕кр╕╕р╕ар╕▓р╕Юр╕Ир╕░р╕Кр╣Ир╕зр╕вр╣Гр╕лр╣Йр╕кр╕╖р╣Ир╕нр╕кр╕▓р╕гр╣Др╕Фр╣Йр╕Фр╕╡р╕Бр╕зр╣Ир╕▓р╕Др╕гр╕▒р╕Ъ р╕ер╕нр╕Зр╣Ар╕ер╣Ир╕▓р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╕нр╕вр╕▓р╕Бр╕Юр╕╣р╕Фр╣Гр╕лр╕бр╣Ир╣Др╕Фр╣Йр╣Др╕лр╕бр╕ер╕╣р╕Б?",
        'score' => 8,
        'priority' => 'WARNING'
    ],

    // === COMPUTING SCIENCE ===
    'comp_sci' => [
        'keywords' => ['р╕зр╕┤р╕Чр╕вр╕▓р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У', 'computational thinking', 'р╣Бр╕Щр╕зр╕Др╕┤р╕Фр╣Ар╕Кр╕┤р╕Зр╕Др╕│р╕Щр╕зр╕У', 'р╕нр╕▒р╕ер╕Бр╕нр╕гр╕┤р╕Чр╕╢р╕б', 'algorithm', 'decomposition', 'р╣Бр╕вр╕Бр╕кр╣Ир╕зр╕Щ', 'pattern recognition', 'р╕лр╕▓р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ', 'abstraction', 'р╕Щр╕▓р╕бр╕Шр╕гр╕гр╕б', 'р╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕б', 'р╕ер╕│р╕Фр╕▒р╕Ър╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ', 'flowchart', 'р╕Ьр╕▒р╕Зр╕Зр╕▓р╕Щ'],
        'responses' => [
            'р╕зр╕┤р╕Чр╕вр╕▓р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У' => "ЁЯУЪ **р╕зр╕┤р╕Чр╕вр╕▓р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У (Computing Science)**\nр╣Ар╕Ыр╣Зр╕Щр╕зр╕┤р╕Кр╕▓р╕Чр╕╡р╣Ир╕кр╕нр╕Щр╣Гр╕лр╣Йр╣Ар╕гр╕▓р╕Др╕┤р╕Фр╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕Ыр╣Зр╕Щр╕гр╕░р╕Ър╕Ъ р╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓р╣Др╕Фр╣Йр╣Ар╕лр╕бр╕╖р╕нр╕Щр╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕Др╕нр╕бр╕Юр╕┤р╕зр╣Ар╕Хр╕нр╕гр╣М\n\n**р╣Ар╕кр╕▓р╕лр╕ер╕▒р╕Б 4 р╕Фр╣Йр╕▓р╕Щ:**\n1. **Decomposition** - р╣Бр╕вр╕Бр╕Ыр╕▒р╕Нр╕лр╕▓р╣Гр╕лр╕Нр╣Ир╣Ар╕Ыр╣Зр╕Щр╕Ыр╕▒р╕Нр╕лр╕▓р╕вр╣Ир╕нр╕в\n2. **Pattern Recognition** - р╕лр╕▓р╕Др╕зр╕▓р╕бр╕Лр╣Йр╕│/р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ\n3. **Abstraction** - р╕Хр╕▒р╕Фр╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Фр╣Др╕бр╣Ир╕кр╕│р╕Др╕▒р╕Нр╕нр╕нр╕Б\n4. **Algorithm Design** - р╕нр╕нр╕Бр╣Бр╕Ър╕Ър╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓\n\nр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З: р╕Чр╕│р╣Бр╕Лр╕Щр╕Фр╣Мр╕зр╕┤р╕К тЖТ р╣Бр╕вр╕Бр╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ тЖТ р╕лр╕вр╕┤р╕Ър╕Вр╕Щр╕бр╕Ыр╕▒р╕З тЖТ р╕Чр╕▓р╣Ар╕Щр╕в тЖТ р╣Гр╕кр╣Ир╣Др╕кр╣Й тЖТ р╕Ыр╕┤р╕Фр╕Эр╕▓ ЁЯек",
            'р╣Бр╕Щр╕зр╕Др╕┤р╕Фр╣Ар╕Кр╕┤р╕Зр╕Др╕│р╕Щр╕зр╕У' => "ЁЯза **р╣Бр╕Щр╕зр╕Др╕┤р╕Фр╣Ар╕Кр╕┤р╕Зр╕Др╕│р╕Щр╕зр╕У (Computational Thinking)**\nр╕Др╕╖р╕нр╕зр╕┤р╕Шр╕╡р╕Др╕┤р╕Фр╣Бр╕Бр╣Йр╕Ыр╕▒р╕Нр╕лр╕▓р╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕Ыр╣Зр╕Щр╕гр╕░р╕Ър╕Ъ р╕бр╕╡ 4 р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ:\n\n1. **Decomposition** (р╣Бр╕Хр╕Бр╕Ыр╕▒р╕Нр╕лр╕▓)\n2. **Pattern Recognition** (р╕лр╕▓р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ)\n3. **Abstraction** (р╕кр╕▓р╕гр╕░р╕кр╕│р╕Др╕▒р╕Н)\n4. **Algorithm** (р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕зр╕┤р╕Шр╕╡)",
            'р╕нр╕▒р╕ер╕Бр╕нр╕гр╕┤р╕Чр╕╢р╕б' => "ЁЯФв **р╕нр╕▒р╕ер╕Бр╕нр╕гр╕┤р╕Чр╕╢р╕б (Algorithm)**\nр╕Др╕╖р╕н р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Чр╕╡р╣Ир╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ р╣Ар╕лр╕бр╕╖р╕нр╕Щр╕кр╕╣р╕Хр╕гр╕Чр╕│р╕нр╕▓р╕лр╕▓р╕г\n\nр╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З: р╕нр╕▒р╕ер╕Бр╕нр╕гр╕┤р╕Чр╕╢р╕бр╕Бр╕▓р╕гр╕Вр╣Йр╕▓р╕бр╕Цр╕Щр╕Щ:\n1. р╕лр╕вр╕╕р╕Фр╕гр╕нр╕Чр╕╡р╣Ир╕Чр╕▓р╕Зр╕бр╣Йр╕▓р╕ер╕▓р╕в\n2. р╕бр╕нр╕Зр╕Лр╣Йр╕▓р╕в-р╕Вр╕зр╕▓\n3. р╕Цр╣Йр╕▓р╕зр╣Ир╕▓р╕З -> р╕Вр╣Йр╕▓р╕бр╣Др╕Фр╣Й\n4. р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕зр╣Ир╕▓р╕З -> р╕гр╕нр╕Хр╣Ир╕нр╣Др╕Ы",
            'default' => "р╕зр╕┤р╕Чр╕вр╕▓р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕кр╕Щр╕╕р╕Бр╕Щр╕░р╕Др╕гр╕▒р╕Ъ! р╕нр╕вр╕▓р╕Бр╕гр╕╣р╣Йр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╣Др╕лр╕Щр╣Ар╕Ир╕▓р╕░р╕Ир╕Зр╕Цр╕▓р╕бр╕Др╕гр╕╣р╣Др╕Фр╣Йр╣Ар╕ер╕в"
        ]
    ],

    // === CODING ===
    'coding' => [
        'keywords' => ['р╣Ар╕Вр╕╡р╕вр╕Щр╣Вр╕Др╣Йр╕Ф', 'р╣Ар╕Вр╕╡р╕вр╕Щр╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕б', 'coding', 'python', 'php', 'html', 'css', 'javascript', 'р╣Ар╕гр╕┤р╣Ир╕бр╣Ар╕Вр╕╡р╕вр╕Щр╕вр╕▒р╕Зр╣Др╕З', 'р╣Ар╕гр╕┤р╣Ир╕бр╕вр╕▒р╕Зр╣Др╕З', 'р╕кр╕нр╕Щр╣Ар╕Вр╕╡р╕вр╕Щ', 'р╕ар╕▓р╕йр╕▓р╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕б', 'р╣Ар╕зр╣Зр╕Ъ', 'р╣Бр╕нр╕Ы'],
        'responses' => [
            'python' => "ЁЯРН **Python**\nр╕ар╕▓р╕йр╕▓р╕Чр╕╡р╣Ир╣Ар╕лр╕бр╕▓р╕░р╕Бр╕▒р╕Ър╕Ьр╕╣р╣Йр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф!\n`print('Hello World')`\nр╣Бр╕Др╣Ир╕Щр╕╡р╣Йр╕Бр╣Зр╕Чр╕│р╕Зр╕▓р╕Щр╣Бр╕ер╣Йр╕з р╕Зр╣Ир╕▓р╕вр╣Др╕лр╕б?",
            'php' => "ЁЯРШ **PHP**\nр╕ар╕▓р╕йр╕▓р╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕зр╣Зр╕Ър╕Эр╕▒р╣Ир╕З Server (Back-end) р╣Ар╕лр╕бр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╕Др╕гр╕╣р╣Гр╕Кр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕зр╣Зр╕Ър╕Щр╕╡р╣Йр╣Др╕З!",
            'html' => "ЁЯМР **HTML**\nр╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕лр╕ер╕▒р╕Бр╕Вр╕нр╕Зр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ р╣Ар╕Ыр╕гр╕╡р╕вр╕Ър╣Ар╕лр╕бр╕╖р╕нр╕Щр╕Бр╕гр╕░р╕Фр╕╣р╕Бр╕Вр╕нр╕Зр╕гр╣Ир╕▓р╕Зр╕Бр╕▓р╕в",
            'default' => "р╕Бр╕▓р╕гр╣Ар╕Вр╕╡р╕вр╕Щр╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕бр╕Эр╕╢р╕Бр╕Бр╕▓р╕гр╕Др╕┤р╕Фр╣Ар╕Ыр╣Зр╕Щр╕гр╕░р╕Ър╕Ър╕Др╕гр╕▒р╕Ъ р╣Ар╕гр╕┤р╣Ир╕бр╕Ир╕▓р╕Б Python р╕Зр╣Ир╕▓р╕вр╕кр╕╕р╕Фр╕Щр╕░!"
        ]
    ],

    // === GREETING / GENERAL ===
    'greeting' => [
        'keywords' => ['р╕кр╕зр╕▒р╕кр╕Фр╕╡', 'р╕Чр╕▒р╕Бр╕Чр╕▓р╕в', 'р╕лр╕зр╕▒р╕Фр╕Фр╕╡', 'р╕Кр╕╖р╣Ир╕нр╕нр╕░р╣Др╕г', 'р╣Гр╕Др╕гр╕кр╕гр╣Йр╕▓р╕З', 'р╣Ар╕Шр╕нр╣Ар╕Ыр╣Зр╕Щр╣Гр╕Др╕г', 'р╕кр╕Ър╕▓р╕вр╕Фр╕╡р╣Др╕лр╕б', 'р╕Вр╕нр╕Ър╕Др╕╕р╕У', 'р╕Ър╕▓р╕в'],
        'responses' => [
            'р╕Кр╕╖р╣Ир╕нр╕нр╕░р╣Др╕г' => "р╕Др╕гр╕╣р╕Кр╕╖р╣Ир╕н **\"р╕Др╕гр╕╣р╣Ар╕Хр╕┤р╣Йр╕е AI\"** р╕Др╕гр╕▒р╕Ъ ЁЯдЦ р╣Ар╕Ыр╣Зр╕Щр╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕вр╕кр╕нр╕Щр╕нр╕▒р╕Ир╕Йр╕гр╕┤р╕вр╕░р╕Чр╕╡р╣Ир╕Др╕гр╕╣р╣Ар╕Хр╕┤р╣Йр╕ер╕Хр╕▒р╕зр╕Ир╕гр╕┤р╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Вр╕╢р╣Йр╕Щр╕бр╕▓",
            'р╣Гр╕Др╕гр╕кр╕гр╣Йр╕▓р╕З' => "р╕Ьр╕╣р╣Йр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕гр╕╣р╕Др╕╖р╕н **\"р╕Др╕гр╕╣р╣Ар╕Хр╕┤р╣Йр╕е\"** р╕Др╕╕р╕Ур╕Др╕гр╕╣р╕кр╕нр╕Щр╕зр╕┤р╕Чр╕вр╕▓р╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕Ур╕кр╕╕р╕Фр╕лр╕ер╣Ир╕нр╕Ыр╕гр╕░р╕Ир╕│р╣Вр╕гр╕Зр╣Ар╕гр╕╡р╕вр╕Щр╕Др╕гр╕▒р╕Ъ (р╕ер╣Йр╕нр╣Ар╕ер╣Ир╕Щр╕Др╕гр╕▒р╕Ъ 555)",
            'default' => "р╕кр╕зр╕▒р╕кр╕Фр╕╡р╕Др╕гр╕▒р╕Ър╕ер╕╣р╕Бр╕ир╕┤р╕йр╕вр╣Мр╕Др╕Щр╣Ар╕Бр╣Ир╕З! ЁЯШК р╕бр╕╡р╕нр╕░р╣Др╕гр╣Гр╕лр╣Йр╕Др╕гр╕╣р╕Кр╣Ир╕зр╕вр╣Др╕лр╕бр╣Ар╕нр╣Ир╕в?"
        ]
    ]
];

// ========== 5. SEARCH LOGIC ==========
$finalReply  = "";
$detectedRisk = false;
$detectedBad  = false;
$msgLower    = mb_strtolower($userMsg, 'UTF-8');

// Helper function
if (!function_exists('findKeyword')) {
    function findKeyword($msg, $keywords) {
        foreach ($keywords as $kw) {
            if (mb_strpos($msg, mb_strtolower($kw, 'UTF-8')) !== false) {
                return $kw;
            }
        }
        return false;
    }
}

// 5.1 Risk Check (Emergency)
if ($foundKw = findKeyword($msgLower, $knowledgeBase['risk']['keywords'])) {
    $finalReply = $knowledgeBase['risk']['reply'];
    $detectedRisk = true;
}

// 5.2 Bad Words Check
if (!$detectedRisk && ($foundKw = findKeyword($msgLower, $knowledgeBase['bad_words']['keywords']))) {
    $finalReply = $knowledgeBase['bad_words']['reply'];
    $detectedBad = true;
}

// 5.3 Category Check
if (!$detectedRisk && !$detectedBad) {
    foreach ($knowledgeBase as $cat => $data) {
        if ($cat == 'risk' || $cat == 'bad_words') continue;
        
        if (findKeyword($msgLower, $data['keywords'] ?? [])) {
            $responses = $data['responses'] ?? [];
            
            // Find specific match first
            foreach ($responses as $key => $resp) {
                if ($key !== 'default' && mb_strpos($msgLower, mb_strtolower($key, 'UTF-8')) !== false) {
                    $finalReply = $resp;
                    break;
                }
            }
            // Fallback to category default
            if (empty($finalReply) && isset($responses['default'])) {
                $finalReply = $responses['default'];
            }
            if (!empty($finalReply)) break;
        }
    }
}

// 5.4 Default Fallback
if (empty($finalReply)) {
    $finalReply = "р╣Ар╕Ыр╣Зр╕Щр╕Др╕│р╕Цр╕▓р╕бр╕Чр╕╡р╣Ир╕Фр╕╡р╕Др╕гр╕▒р╕Ъ! р╕Др╕гр╕╣р╕нр╕▓р╕Ир╕Ир╕░р╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕Щр╕╡р╣Й р╣Ар╕Фр╕╡р╣Лр╕вр╕зр╕Др╕гр╕╣р╕Ир╕░р╣Др╕Ыр╕ир╕╢р╕Бр╕йр╕▓р╣Ар╕Юр╕┤р╣Ир╕бр╕Щр╕░ р╣Бр╕Хр╣Ир╕Цр╣Йр╕▓р╣Ар╕Ыр╣Зр╕Щр╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕Др╕нр╕бр╕Юр╕┤р╕зр╣Ар╕Хр╕нр╕гр╣М р╕Др╕гр╕╣р╕Цр╕Щр╕▒р╕Фр╣Ар╕ер╕вр╕ер╕нр╕Зр╕Цр╕▓р╕бр╕Фр╕╣р╣Др╕Фр╣Йр╕Др╕гр╕▒р╕Ъ";
}

// ========== 6. LINE BROADCAST ==========
// Broadcast Message to Teacher Line Account via Messaging API
$lineAlertMsg = "";

if ($detectedRisk) {
    $lineAlertMsg = "ЁЯЪи **р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Йр╕╕р╕Бр╣Ар╕Йр╕┤р╕Щ!** ЁЯЪи\n\nр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ: $fullName\nр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б: \"$userMsg\"\nр╕гр╕░р╕Фр╕▒р╕Ъ: ЁЯФ┤ р╕нр╕▒р╕Щр╕Хр╕гр╕▓р╕в (Risk)\n\nтЪая╕П р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Фр╣Ир╕зр╕Щ!";
} elseif ($detectedBad) {
    $lineAlertMsg = "тЪая╕П **р╣Бр╕Ир╣Йр╕Зр╣Ар╕Хр╕╖р╕нр╕Щр╕Др╕│р╕лр╕вр╕▓р╕Ъ** тЪая╕П\n\nр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ: $fullName\nр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б: \"$userMsg\"\n\nтЫФ р╕гр╕░р╕Ър╕Ър╣Др╕Фр╣Йр╕Хр╕▒р╕Бр╣Ар╕Хр╕╖р╕нр╕Щр╣Бр╕ер╣Йр╕з";
} else {
    // Normal message notification
    $lineAlertMsg = "ЁЯТм **р╕Вр╣Йр╕нр╕Др╕зр╕▓р╕бр╣Гр╕лр╕бр╣И**\n\nр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ: $fullName\nр╕Цр╕▓р╕б: \"$userMsg\"\nр╕Хр╕нр╕Ъ: " . mb_substr(strip_tags($finalReply), 0, 50, 'UTF-8') . "...";
}

// Send to LINE
if (!empty($lineAlertMsg)) {
    $ch = curl_init('https://api.line.me/v2/bot/message/broadcast');
    curl_setopt_array($ch, [
        CURLOPT_POST           => true,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_SSL_VERIFYPEER => false, // Dev only
        CURLOPT_HTTPHEADER     => [
            'Content-Type: application/json',
            'Authorization: Bearer ' . $lineToken
        ],
        CURLOPT_POSTFIELDS     => json_encode([
            'messages' => [['type' => 'text', 'text' => $lineAlertMsg]]
        ])
    ]);
    $result = curl_exec($ch);
    $err = curl_error($ch);
    curl_close($ch);
    
    // Debug log if needed
    // file_put_contents('line_log.txt', date('Y-m-d H:i:s')." Result: $result | Err: $err\n", FILE_APPEND);
}

// ========== 7. DATABASE LOGGING ==========
$sentScore = $detectedRisk ? 10.0 : ($detectedBad ? 8.0 : 0.0);
$logSql = "INSERT INTO ai_chat_logs (student_id, user_message, ai_response, sentiment_score) VALUES (?, ?, ?, ?)";
$stmt = $conn->prepare($logSql);
if ($stmt) {
    $stmt->bind_param("issd", $userId, $userMsg, $finalReply, $sentScore);
    $stmt->execute();
}

// ========== 8. OUTPUT ==========
echo json_encode([
    'status' => 'success', 
    'reply' => $finalReply
], JSON_UNESCAPED_UNICODE);
?>